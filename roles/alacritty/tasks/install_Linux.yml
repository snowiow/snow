- name: Include version vars
  include_vars: "{{ playbook_dir }}/versions.yaml"

- name: Check if Alacritty is already installed
  stat:
    path: /usr/local/bin/alacritty
  register: alacritty_binary

- name: Get installed Alacritty version
  shell: /usr/local/bin/alacritty --version | grep -oP 'alacritty \K[\d.]+'
  register: alacritty_installed_version
  when: alacritty_binary.stat.exists
  failed_when: false
  changed_when: false

- name: Download Alacritty Repo
  ansible.builtin.git:
    repo: git@github.com:alacritty/alacritty.git
    dest: ~/workspace/alacritty
    version: "v{{ alacritty }}"
  when: not alacritty_binary.stat.exists or alacritty_installed_version.stdout != alacritty

- name: Make sure Alacritty dependencies are installed
  package:
    name:
      - cmake
      - pkg-config
      - libfreetype6-dev
      - libfontconfig1-dev
      - libxcb-xfixes0-dev
      - libxkbcommon-dev
      - python3
    state: present
  become: yes
  when: not alacritty_binary.stat.exists or alacritty_installed_version.stdout != alacritty

- name: Build Alacritty
  shell:
    chdir: ~/workspace/alacritty
    cmd: cargo build --release
  when: not alacritty_binary.stat.exists or alacritty_installed_version.stdout != alacritty

- name: Copy Alacritty to bin
  ansible.builtin.copy:
    src: "{{ ansible_env.HOME }}/workspace/alacritty/target/release/alacritty"
    dest: /usr/local/bin
    mode: a+x
  become: yes
  when: not alacritty_binary.stat.exists or alacritty_installed_version.stdout != alacritty

- name: Copy Alacritty svg
  ansible.builtin.copy:
    src: "{{ ansible_env.HOME }}/workspace/alacritty/extra/logo/alacritty-term.svg"
    dest: /usr/share/pixmaps/Alacritty.svg
  become: yes

- name: Alacritty Desktop File Install
  shell: 
    chdir: "{{ ansible_env.HOME }}/workspace/alacritty"
    cmd: desktop-file-install extra/linux/Alacritty.desktop && update-desktop-database
  become: yes
