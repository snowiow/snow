#! /usr/bin/env bash

tail -n +6 $1                                                   | # remove original header
ghead -n -3                                                      | # remove footer
    gtac                                                        | # reverse the entry order
    iconv -f ISO8859-1 -t utf8                                  |
    sed -E 's/(-?)([0-9]+)\.([0-9]+),([0-9]+)/\1\2\3,\4/g'      | # remove dots from amounts
    sed -E 's/(-?)([0-9]+),([0-9]+)/\1\2\.\3 EUR/g'             | # from de to en number format
    sed -E 's/,/ /g'                                            | # substitute commas with whitspaces
    sed -E 's/"//g'                                             | # remove quotation marks
    sed -E 's/;/,/g'                                            | # use commas as separators instead of semicolon
    cut -d , -f 1,4,5                                           | # keep only relevant columns
    sed -E '1s/^/date,desc,amount\n/'                           | # append ledger header
    ledger convert /dev/stdin \
        --invert \
        --input-date-format "%d.%m.%Y" \
        --account $2 \
        --file "~/Seafile/My Library/ledger/main.ledger" | cat
